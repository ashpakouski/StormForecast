package com.shpak.stormalert.presentation.map

import android.app.ActivityManager
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.Path
import androidx.compose.ui.platform.LocalContext
import androidx.core.content.res.ResourcesCompat
import androidx.core.graphics.drawable.toBitmap
import com.google.gson.Gson
import com.shpak.stormalert.R
import kotlin.math.sqrt

data class GeoForecast(
    val polygons: List<List<Polygon>>
)

data class Polygon(
    val latitude: Float,
    val longitude: Float
)

@Composable
fun MapScreen() {
    Box(
        modifier = Modifier.fillMaxSize()
    ) {
        // val maxBitmapPixelCount = 150 * 1024 * 1024 / 4
        val drawable = ResourcesCompat.getDrawable(
            LocalContext.current.resources,
            R.drawable.world_location_map_optimized,
            null
        )
        val activityManager = LocalContext.current.getSystemService(ActivityManager::class.java)
        val memoryClassMB = activityManager.memoryClass
        val maxBitmapPixelCount = memoryClassMB * 1024 * 1024 / 8

        val polygons = Gson().fromJson(TestJson, GeoForecast::class.java).polygons

        if (drawable != null) {
            val aspect = drawable.intrinsicWidth / drawable.intrinsicHeight
            val height = sqrt(maxBitmapPixelCount / aspect.toFloat())
            val width = height * aspect
            val bitmap = drawable.toBitmap(width.toInt(), height.toInt())

            PinchToZoomImage(
                bitmap = bitmap,
                scaleMax = 5f,
                modifier = Modifier.fillMaxSize(),
                drawAbove = {
                    polygons.forEach { polygon ->
                        val path = Path().apply {
                            moveTo(
                                polygon.first().longitude.asLongitudeNormalized() * size.width,
                                polygon.first().latitude.asLatitudeNormalized() * size.height
                            )
                            polygon.takeLast(polygon.size - 1).forEach { point ->
                                lineTo(
                                    point.longitude.asLongitudeNormalized() * size.width,
                                    point.latitude.asLatitudeNormalized() * size.height
                                )
                            }
                            close()
                        }

                        drawPath(
                            path = path,
                            color = Color.Red.copy(alpha = 0.5f)
                        )
                    }

                    val lat = 40.447266f
                    val lon = -3.706207f

                    drawCircle(
                        color = Color.Red,
                        center = Offset(
                            lon.asLongitudeNormalized() * size.width,
                            lat.asLatitudeNormalized() * size.height
                        ),
                        radius = 5f
                    )
                }
            )
        }
    }
}

// Changes from 0.0 (left) to 1.0 (right)
private fun Float.asLatitudeNormalized(): Float = (1.0f - (this + 90f) / 180f)
    .coerceIn(0.0f..1.0f)

// Changes from 0.0 (North Pole) to 1.0 (South Pole)
private fun Float.asLongitudeNormalized(): Float = ((this + 180f) / 360f)
    .coerceIn(0.0f..1.0f)

private val TestJson = """
{
   "polygons":[
      [
         {
            "latitude":73.0,
            "longitude":83.0,
            "color":-15937272
         },
         {
            "latitude":75.0,
            "longitude":92.0,
            "color":-16070141
         },
         {
            "latitude":76.0,
            "longitude":99.0,
            "color":-16011001
         },
         {
            "latitude":76.0,
            "longitude":107.0,
            "color":-16076281
         },
         {
            "latitude":74.0,
            "longitude":125.0,
            "color":-16265976
         },
         {
            "latitude":72.0,
            "longitude":127.0,
            "color":-16068096
         },
         {
            "latitude":70.0,
            "longitude":126.0,
            "color":-16330239
         },
         {
            "latitude":66.0,
            "longitude":105.0,
            "color":-15834363
         },
         {
            "latitude":66.0,
            "longitude":86.0,
            "color":-15769080
         },
         {
            "latitude":71.0,
            "longitude":80.0,
            "color":-16199164
         }
      ],
      [
         {
            "latitude":-61.0,
            "longitude":-73.0,
            "color":-15959545
         },
         {
            "latitude":-60.0,
            "longitude":-71.0,
            "color":-15311352
         },
         {
            "latitude":-57.0,
            "longitude":-61.0,
            "color":-15516152
         },
         {
            "latitude":-57.0,
            "longitude":-46.0,
            "color":-16084729
         },
         {
            "latitude":-60.0,
            "longitude":-33.0,
            "color":-16264448
         },
         {
            "latitude":-61.0,
            "longitude":-29.0,
            "color":-16329469
         },
         {
            "latitude":-63.0,
            "longitude":-31.0,
            "color":-16200444
         },
         {
            "latitude":-65.0,
            "longitude":-36.0,
            "color":-16265725
         },
         {
            "latitude":-65.0,
            "longitude":-60.0,
            "color":-16197376
         },
         {
            "latitude":-63.0,
            "longitude":-73.0,
            "color":-16202489
         }
      ],
      [
         {
            "latitude":73.0,
            "longitude":83.0,
            "color":-16003065
         },
         {
            "latitude":75.0,
            "longitude":92.0,
            "color":-16004861
         },
         {
            "latitude":76.0,
            "longitude":102.0,
            "color":-16010488
         },
         {
            "latitude":76.0,
            "longitude":106.0,
            "color":-16206329
         },
         {
            "latitude":74.0,
            "longitude":120.0,
            "color":-16329469
         },
         {
            "latitude":73.0,
            "longitude":126.0,
            "color":-16197376
         },
         {
            "latitude":72.0,
            "longitude":127.0,
            "color":-16199934
         },
         {
            "latitude":70.0,
            "longitude":126.0,
            "color":-16264959
         },
         {
            "latitude":69.0,
            "longitude":111.0,
            "color":-16329471
         },
         {
            "latitude":69.0,
            "longitude":92.0,
            "color":-16264446
         },
         {
            "latitude":70.0,
            "longitude":84.0,
            "color":-16264448
         },
         {
            "latitude":71.0,
            "longitude":80.0,
            "color":-16199934
         }
      ],
      [
         {
            "latitude":-62.0,
            "longitude":-67.0,
            "color":-16135416
         },
         {
            "latitude":-60.0,
            "longitude":-66.0,
            "color":-15826425
         },
         {
            "latitude":-58.0,
            "longitude":-63.0,
            "color":-15904504
         },
         {
            "latitude":-57.0,
            "longitude":-61.0,
            "color":-15516921
         },
         {
            "latitude":-56.0,
            "longitude":-39.0,
            "color":-15964921
         },
         {
            "latitude":-56.0,
            "longitude":-38.0,
            "color":-15899642
         },
         {
            "latitude":-61.0,
            "longitude":-30.0,
            "color":-16264446
         },
         {
            "latitude":-63.0,
            "longitude":-31.0,
            "color":-15938553
         },
         {
            "latitude":-65.0,
            "longitude":-37.0,
            "color":-16003579
         },
         {
            "latitude":-65.0,
            "longitude":-60.0,
            "color":-16197376
         },
         {
            "latitude":-64.0,
            "longitude":-67.0,
            "color":-16003578
         }
      ],
      [
         {
            "latitude":69.0,
            "longitude":135.0,
            "color":-16342528
         },
         {
            "latitude":70.0,
            "longitude":142.0,
            "color":-16337148
         },
         {
            "latitude":71.0,
            "longitude":150.0,
            "color":-16269048
         },
         {
            "latitude":71.0,
            "longitude":151.0,
            "color":-16271354
         },
         {
            "latitude":70.0,
            "longitude":158.0,
            "color":-16281338
         },
         {
            "latitude":69.0,
            "longitude":160.0,
            "color":-15764733
         },
         {
            "latitude":68.0,
            "longitude":157.0,
            "color":-15508216
         },
         {
            "latitude":67.0,
            "longitude":139.0,
            "color":-15773947
         },
         {
            "latitude":67.0,
            "longitude":137.0,
            "color":-15903738
         },
         {
            "latitude":68.0,
            "longitude":134.0,
            "color":-15828216
         }
      ],
      [
         {
            "latitude":71.0,
            "longitude":80.0,
            "color":-16199934
         },
         {
            "latitude":73.0,
            "longitude":83.0,
            "color":-16003066
         },
         {
            "latitude":75.0,
            "longitude":95.0,
            "color":-16200185
         },
         {
            "latitude":76.0,
            "longitude":103.0,
            "color":-16207099
         },
         {
            "latitude":76.0,
            "longitude":109.0,
            "color":-16146427
         },
         {
            "latitude":73.0,
            "longitude":126.0,
            "color":-16131584
         },
         {
            "latitude":72.0,
            "longitude":127.0,
            "color":-16264704
         },
         {
            "latitude":70.0,
            "longitude":126.0,
            "color":-16264957
         },
         {
            "latitude":66.0,
            "longitude":92.0,
            "color":-15834362
         },
         {
            "latitude":66.0,
            "longitude":81.0,
            "color":-15639545
         },
         {
            "latitude":67.0,
            "longitude":78.0,
            "color":-16025597
         }
      ],
      [
         {
            "latitude":-64.0,
            "longitude":-67.0,
            "color":-16003576
         },
         {
            "latitude":-61.0,
            "longitude":-66.0,
            "color":-16210425
         },
         {
            "latitude":-59.0,
            "longitude":-65.0,
            "color":-15966200
         },
         {
            "latitude":-58.0,
            "longitude":-63.0,
            "color":-15906297
         },
         {
            "latitude":-56.0,
            "longitude":-46.0,
            "color":-15638264
         },
         {
            "latitude":-56.0,
            "longitude":-42.0,
            "color":-15899896
         },
         {
            "latitude":-61.0,
            "longitude":-30.0,
            "color":-16199166
         },
         {
            "latitude":-63.0,
            "longitude":-31.0,
            "color":-16069112
         },
         {
            "latitude":-65.0,
            "longitude":-37.0,
            "color":-16200955
         },
         {
            "latitude":-65.0,
            "longitude":-67.0,
            "color":-16200696
         }
      ],
      [
         {
            "latitude":69.0,
            "longitude":130.0,
            "color":-16274941
         },
         {
            "latitude":72.0,
            "longitude":141.0,
            "color":-16199166
         },
         {
            "latitude":72.0,
            "longitude":142.0,
            "color":-16003578
         },
         {
            "latitude":71.0,
            "longitude":151.0,
            "color":-16338939
         },
         {
            "latitude":70.0,
            "longitude":157.0,
            "color":-16086012
         },
         {
            "latitude":69.0,
            "longitude":159.0,
            "color":-16029178
         },
         {
            "latitude":68.0,
            "longitude":157.0,
            "color":-15444984
         },
         {
            "latitude":67.0,
            "longitude":145.0,
            "color":-15644408
         },
         {
            "latitude":67.0,
            "longitude":129.0,
            "color":-15835641
         }
      ],
      [
         {
            "latitude":73.0,
            "longitude":83.0,
            "color":-15937786
         },
         {
            "latitude":75.0,
            "longitude":90.0,
            "color":-16332793
         },
         {
            "latitude":77.0,
            "longitude":103.0,
            "color":-15562489
         },
         {
            "latitude":76.0,
            "longitude":110.0,
            "color":-16142587
         },
         {
            "latitude":73.0,
            "longitude":126.0,
            "color":-16132352
         },
         {
            "latitude":72.0,
            "longitude":126.0,
            "color":-16133371
         },
         {
            "latitude":71.0,
            "longitude":124.0,
            "color":-16133371
         },
         {
            "latitude":70.0,
            "longitude":120.0,
            "color":-16263678
         },
         {
            "latitude":65.0,
            "longitude":92.0,
            "color":-15578872
         },
         {
            "latitude":66.0,
            "longitude":87.0,
            "color":-15769080
         },
         {
            "latitude":71.0,
            "longitude":80.0,
            "color":-16264957
         }
      ],
      [
         {
            "latitude":-59.0,
            "longitude":-65.0,
            "color":-15705848
         },
         {
            "latitude":-58.0,
            "longitude":-63.0,
            "color":-15841017
         },
         {
            "latitude":-57.0,
            "longitude":-53.0,
            "color":-15835389
         },
         {
            "latitude":-57.0,
            "longitude":-46.0,
            "color":-16152571
         },
         {
            "latitude":-60.0,
            "longitude":-33.0,
            "color":-16264448
         },
         {
            "latitude":-61.0,
            "longitude":-30.0,
            "color":-16264446
         },
         {
            "latitude":-63.0,
            "longitude":-31.0,
            "color":-16069112
         },
         {
            "latitude":-65.0,
            "longitude":-37.0,
            "color":-15808250
         },
         {
            "latitude":-65.0,
            "longitude":-60.0,
            "color":-16132352
         },
         {
            "latitude":-62.0,
            "longitude":-66.0,
            "color":-16331769
         }
      ],
      [
         {
            "latitude":71.0,
            "longitude":80.0,
            "color":-16134141
         },
         {
            "latitude":73.0,
            "longitude":83.0,
            "color":-16068859
         },
         {
            "latitude":76.0,
            "longitude":99.0,
            "color":-16013560
         },
         {
            "latitude":76.0,
            "longitude":105.0,
            "color":-16082938
         },
         {
            "latitude":73.0,
            "longitude":126.0,
            "color":-15936256
         },
         {
            "latitude":72.0,
            "longitude":127.0,
            "color":-16331264
         },
         {
            "latitude":66.0,
            "longitude":113.0,
            "color":-15838715
         },
         {
            "latitude":66.0,
            "longitude":96.0,
            "color":-16162298
         },
         {
            "latitude":70.0,
            "longitude":80.0,
            "color":-16330752
         }
      ],
      [
         {
            "latitude":-60.0,
            "longitude":-69.0,
            "color":-15774201
         },
         {
            "latitude":-59.0,
            "longitude":-64.0,
            "color":-15705338
         },
         {
            "latitude":-59.0,
            "longitude":-38.0,
            "color":-16330493
         },
         {
            "latitude":-60.0,
            "longitude":-33.0,
            "color":-16264448
         },
         {
            "latitude":-61.0,
            "longitude":-30.0,
            "color":-16264446
         },
         {
            "latitude":-63.0,
            "longitude":-31.0,
            "color":-16069369
         },
         {
            "latitude":-65.0,
            "longitude":-37.0,
            "color":-16266748
         },
         {
            "latitude":-65.0,
            "longitude":-60.0,
            "color":-15936256
         },
         {
            "latitude":-64.0,
            "longitude":-71.0,
            "color":-16200187
         },
         {
            "latitude":-63.0,
            "longitude":-73.0,
            "color":-16146427
         }
      ]
   ]
}
""".trimIndent()